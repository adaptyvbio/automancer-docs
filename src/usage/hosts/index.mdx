import { Brand, LangBrand } from '../../shared';

export const title = 'Managing setups';


# {title}

A _setup_, internally known as a _host_, is an object which defines a physical setup.


## Adding a setup

Setups can be added by clicking **New setup** on the launch window.

Every setup depends on a Python binary, which can be the system's installation or an embedded binary. All Python packages present in this installation's import path will be searched for modules.


## Installing modules

Modules are installed by updating the `requirements.in` file in the setup's directory. The setup's directory can be found from the launch window: **Right click on a setup → Reveal settings in explorer → Open `requirements.in`**.

The `requirements.in` file can be opened with a text editor. Each line in this file maps to a Python package which can provide zero or more modules, although usually a single module.

To add a package, just add a line with the corresponding package's name, as visible on PyPI or the official {Brand} package registry. You can optionally add a version number, for example `pr1-nikon-microscope~=4.2.0` to enforce version 4.2.X.

```diff
  --extra-index-url (...)

  pip-tools~=6.13.0

  pr1
  pr1-server

  # Only add packages below

  pr1-amf
+ pr1-nikon-microscope
```

Packages mentioned in this file will be installed when launching the setup, which can take a few minutes. Modules contained in the package will be automatically loaded and enabled shortly after.

To remove a package, remove the corresponding line and restart the setup. To update a package, optionally update the provided version number and restart the setup. To install modules for development, see [Module development](../../../development).


## Configuring a setup

A setup's configuration can be found from the launch window: **Right click on a setup → Reveal settings in explorer → Open `setup.yml`**. This file is written in {LangBrand}. For more information, see [Writing configuration](../../config-lang).

The following root attributes are available:

- `id` (identifier, required) – A unique id associated to this setup. Automatically generated.
- `name` (string, required) – The name of the setup. Automatically generated with the computer's name.
- `units` (dictionary) – A dictionary listing the configuration of every module. See [Module](#) for details.
- `version` (string, required) – The version of the configuration's schema, for backwards compatibility. Automatically generated and updated.


### Modules

The configuration of modules is provided in the setup configuration file as key-value pairs where the key is the module's namespace.

```yml
units:
  nikon_microscope:
    # <- Options regarding module initialization here
    options:
      # <- Options passed to the module here
```

The following options for module initialization are available:

- `development` (boolean) – Whether to load the module in [development mode](#). Defaults to false.
- `enabled` (boolean) – Whether the module is enabled. Defaults to true.
- `module` (string) – The module's name (e.g. `a.b.c`) indicating where to find the module if it is [not registered as an entry point](#) but present in `sys.path`. This is for development only. If `path` is also present, `module` will only be used to name the module but not to locate it.
- `options` (object) – Options passed to the module. Defaults to an empty dictionary.
- `path` (string) – The module's absolute path (e.g. `/path/to/a/b/c.py`) indicating where to find the module if it is not registered as an entry point and not present in `sys.path`. This is for development only.

By default, all modules installed in `sys.path` are loaded and enabled even if they are not mentioned in the configuration.


### Registering devices

Several modules interact with external devices and follow a similar pattern when defining the configuration of these devices. This configuration starts with a `devices` attribute in the module options, which defines a list of devices. Each device can the following properties:

- `id` (identifier, required) – A string unique to this device among all devices in the setup. This id will be used to reference the device in protocols.
- `label` (string) – The name of the device. Defaults to a name provided by the device itself, the name of its manufacturer, the device's model, its serial number, its `id`, or a similar string.
- `model` (string, sometimes required) – The model of the device. This can sometimes be detected automatically by communicating with the device or using information from the underlying protocol, such as the product id in the case of USB.
- One or more options to locate the device, such as:
  - `address` (number or string) – The address of the device, such as an IP address and port (e.g. `17.244.221.152:6513`), a full address with credentials (e.g. `user:pass@server.net`), a serial port (e.g. `COM3` or `/dev/tty.usbmodem1101`) or a USB bus address (e.g. `5`).
  - `serial` (string) – The serial number of the device, as defined by the manufacturer.
- Other options depending on the module and `model`.

Below is an example:

```yml
units:
  nikon_microscope:
    options:
      devices:
        - id: Microscope1
          label: Microscope no. 1
          model: NikonTi1
          address: COM3
          # <- Other options here
        - id: Microscope2
          # ...
```


## Troubleshooting launch errors

All errors that occur during launch are printed to a log file, which can be found from the launch window: **Right click on a setup → Reveal logs in explorer**. The file with the largest number corresponds to the latest log.
